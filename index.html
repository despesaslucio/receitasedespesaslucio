<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --cor-fundo: #f0f2f5; --cor-texto: #363f5f; --cor-texto-leve: #969cb3; --cor-card: #ffffff; --cor-borda: #e2e8f0; --cor-verde: #10b981; --cor-vermelho: #ef4444; --cor-azul: #3b82f6; --cor-amarelo-fundo: #fef9c3; --cor-amarelo-texto: #a16207; --sombra-card: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --transicao: all 0.3s ease-in-out; }
        body.dark-mode { --cor-fundo: #1a202c; --cor-texto: #e2e8f0; --cor-texto-leve: #a0aec0; --cor-card: #2d3748; --cor-borda: #4a5568; --cor-amarelo-fundo: #4a4a28; --cor-amarelo-texto: #fef08a;}
        body { font-family: 'Poppins', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); margin: 0; padding: 20px; transition: var(--transicao); }
        .container { max-width: 1600px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 25px; flex-wrap: wrap; gap: 15px; border-bottom: 1px solid var(--cor-borda); margin-bottom: 25px; }
        .header-title { display: flex; align-items: center; gap: 15px; }
        header h1 { margin: 0; font-size: 2em; }
        .btn { padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transicao); font-weight: 500; border: none; cursor: pointer; }
        .btn-verde { background-color: var(--cor-verde); color: white; }
        .btn-vermelho { background-color: var(--cor-vermelho); color: white; }
        .btn-azul { background-color: var(--cor-azul); color: white; }
        .btn-icon { background: none; border: none; font-size: 1.1em; cursor: pointer; color: var(--cor-texto-leve); transition: var(--transicao); padding: 5px; }
        .btn-icon:hover { color: var(--cor-texto); }
        .cards-resumo { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .card { background-color: var(--cor-card); padding: 25px; border-radius: 12px; box-shadow: var(--sombra-card); border: 1px solid var(--cor-borda); transition: var(--transicao); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .card.clicavel { cursor: pointer; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: var(--cor-texto-leve); font-weight: 500; }
        .card-header i { font-size: 2em; }
        .card .valor { font-size: 2.2em; font-weight: 600; }
        .card.receitas { border-left: 5px solid var(--cor-verde); } .card.receitas .valor, .card.receitas i { color: var(--cor-verde); }
        .card.despesas { border-left: 5px solid var(--cor-vermelho); } .card.despesas .valor, .card.despesas i { color: var(--cor-vermelho); }
        .card.saldo { border-left: 5px solid var(--cor-azul); } .card.saldo .valor, .card.saldo i { color: var(--cor-azul); }
        .secao-filtros { background-color: var(--cor-card); padding: 20px; border-radius: 12px; box-shadow: var(--sombra-card); margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .grupo-filtro { display: flex; align-items: center; gap: 10px; }
        .btn-filtro { background-color: var(--cor-fundo); border: 1px solid var(--cor-borda); padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: var(--transicao); font-weight: 500; }
        .btn-filtro.active { background-color: var(--cor-azul); color: white; border-color: var(--cor-azul); }
        .grid-principal { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .widget { background-color: var(--cor-card); padding: 25px; border-radius: 12px; box-shadow: var(--sombra-card); border: 1px solid var(--cor-borda); position: relative; }
        .widget h2 { margin-top: 0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .tabela-contas-wrapper { max-height: 400px; overflow-y: auto; }
        .tabela-contas { width: 100%; border-collapse: collapse; }
        .tabela-contas th, .tabela-contas td { text-align: left; padding: 14px; border-bottom: 1px solid var(--cor-borda); }
        .tabela-contas thead { position: sticky; top: 0; background-color: var(--cor-card); z-index: 1; }
        .tabela-contas tbody tr:hover { background-color: var(--cor-fundo); }
        .tabela-contas .status-Pendente { background-color: var(--cor-amarelo-fundo); color: var(--cor-amarelo-texto); font-weight: 500; }
        .tabela-contas .acoes { display: flex; gap: 10px; }
        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--cor-card); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: scaleUp 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-body { overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content form { display: flex; flex-direction: column; gap: 15px; }
        .form-grupo { display: flex; flex-direction: column; gap: 5px; }
        .form-grupo label { font-weight: 500; font-size: 0.9em; color: var(--cor-texto-leve); }
        .modal-content input, .modal-content select { padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; font-size: 1em; background-color: var(--cor-fundo); color: var(--cor-texto); }
        .form-botoes { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        @media (max-width: 1200px) { .grid-principal { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { body { padding: 10px; } header h1 { font-size: 1.5em; } .secao-filtros { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <h1>Dashboard Financeiro</h1>
                <button class="btn-icon" id="btn-export-receitas" title="Exportar Relat√≥rio de Receitas"><i class="fa-solid fa-file-pdf"></i></button>
                <button class="btn-icon" id="btn-export-despesas" title="Exportar Relat√≥rio de Despesas"><i class="fa-solid fa-file-invoice-dollar"></i></button>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn-icon" id="btn-toggle-theme" title="Mudar tema"><i class="fa-solid fa-moon"></i></button>
                <div class="grupo-botoes-registro">
                    <button id="btn-abrir-modal-receita" class="btn btn-verde"><i class="fa-solid fa-plus"></i> Receita</button>
                    <button id="btn-abrir-modal-despesa" class="btn btn-vermelho"><i class="fa-solid fa-minus"></i> Despesa</button>
                </div>
            </div>
        </header>

        <main>
            <section class="cards-resumo">
                <div class="card receitas clicavel" id="card-receitas"><div class="card-header"><span>Receitas</span><i class="fa-solid fa-circle-arrow-up"></i></div><p class="valor" id="total-receitas">R$ 0,00</p></div>
                <div class="card despesas clicavel" id="card-despesas"><div class="card-header"><span>Despesas</span><i class="fa-solid fa-circle-arrow-down"></i></div><p class="valor" id="total-despesas">R$ 0,00</p></div>
                <div class="card saldo clicavel" id="card-saldo"><div class="card-header"><span>Saldo</span><i class="fa-solid fa-scale-balanced"></i></div><p class="valor" id="saldo-total">R$ 0,00</p></div>
            </section>
            
            <section class="secao-filtros">
                 <div class="grupo-filtro" id="filtro-tipo"><button class="btn-filtro active" data-tipo="Todos">Todos</button><button class="btn-filtro" data-tipo="Receita">Receitas</button><button class="btn-filtro" data-tipo="Despesa">Despesas</button></div>
                 <div class="grupo-filtro" id="filtro-periodo"><button class="btn-filtro" data-periodo="Diario">Hoje</button><button class="btn-filtro" data-periodo="Semanal">Semana</button><button class="btn-filtro active" data-periodo="Mensal">M√™s</button><button class="btn-filtro" data-periodo="Anual">Ano</button></div>
            </section>
            
            <div id="loading" style="text-align: center; padding: 50px; font-size: 1.5em; color: var(--cor-texto-leve); display: none;"><p><i class="fa-solid fa-spinner fa-spin"></i> Carregando dados...</p></div>

            <div id="dashboard-content">
                <section class="grid-principal">
                    <div class="widget"> <h2 id="titulo-grafico">Evolu√ß√£o Financeira</h2> <canvas id="grafico-linhas"></canvas> </div>
                    <div class="widget"> <h2 id="titulo-categorias">Top 10 Despesas por Fonte</h2> <canvas id="grafico-categorias"></canvas> </div>
                    <div class="widget" style="grid-column: 1 / -1;"> 
                        <h2>Planejador de Contas <button class="btn-icon" id="btn-abrir-modal-planejador" title="Adicionar conta a planejar"><i class="fa-solid fa-plus"></i></button></h2> 
                        <div class="tabela-contas-wrapper"><table class="tabela-contas"><thead><tr><th>Data</th><th>Fonte</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="corpo-tabela-planejador"></tbody></table></div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <div id="modal-detalhes" class="modal-container">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-detalhes-titulo">Detalhes</h2><button id="btn-fechar-detalhes" class="btn-icon">&times;</button></div>
            <div id="modal-detalhes-conteudo" class="modal-body"></div>
        </div>
    </div>

    <div id="modal-registro" class="modal-container">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-registro-titulo">Registrar</h2><button id="btn-fechar-registro" class="btn-icon">&times;</button></div>
            <div class="modal-body">
                <form id="form-registro">
                    <input type="hidden" id="reg-tipo">
                    <div class="form-grupo"><label for="reg-data">Data da Transa√ß√£o</label><input type="date" id="reg-data" required></div>
                    <div class="form-grupo"><label for="reg-local">Local</label><input type="text" id="reg-local" list="datalist-locais" placeholder="Selecione ou digite" required></div>
                    <div class="form-grupo"><label for="reg-fonte">Fonte</label><input type="text" id="reg-fonte" list="datalist-fontes" placeholder="Selecione ou digite" required></div>
                    <div class="form-grupo"><label for="reg-valor">Valor (R$)</label><input type="text" inputmode="decimal" id="reg-valor" placeholder="150,50" required></div>
                    <div class="form-grupo" id="grupo-status"><label for="reg-status">Status</label><select id="reg-status"><option value="Pago">J√° foi pago</option><option value="Pendente">Conta a pagar (pendente)</option></select></div>
                    <div class="form-botoes">
                        <button type="button" class="btn" id="btn-cancelar-registro" style="background-color: #ccc;">Cancelar</button>
                        <button type="submit" class="btn" id="btn-salvar-registro"><span class="btn-text">Salvar</span><i class="fa-solid fa-spinner fa-spin" style="display: none;"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-planejador" class="modal-container">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-planejador-titulo">Adicionar Conta a Pagar</h2><button id="btn-fechar-planejador" class="btn-icon">&times;</button></div>
            <div class="modal-body">
                <form id="form-planejador">
                    <input type="hidden" id="planejador-id">
                    <div class="form-grupo"><label for="planejador-data">Data de Vencimento</label><input type="date" id="planejador-data" required></div>
                    <div class="form-grupo"><label for="planejador-fonte">Fonte da Despesa</label><input type="text" id="planejador-fonte" list="datalist-fontes" placeholder="Selecione ou digite" required></div>
                    <div class="form-grupo"><label for="planejador-valor">Valor (R$)</label><input type="text" inputmode="decimal" id="planejador-valor" placeholder="150,50" required></div>
                    <div class="form-botoes">
                        <button type="button" class="btn" id="btn-cancelar-planejador" style="background-color: #ccc;">Cancelar</button>
                        <button type="submit" class="btn btn-azul"><span class="btn-text">Salvar</span></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <datalist id="datalist-locais"></datalist>
    <datalist id="datalist-fontes"></datalist>

<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';

    const locais = ["Panevie", "Buono Trigo Industria", "Casa"];
    const fontesReceita = ["Cart√£o Panevie", "Cart√£o Industria", "Cart√£o Buono Trigo", "Madrugada", "Outra"];
    const fontesDespesa = ["√Ågua","Aluguel","Arrendamento padaria","Amora","Casa Garcia","Combust√≠vel Fiorino","Combust√≠vel Jumper","Comercial Mab","Confraterniza√ß√£o","Contadora","DAS","Despesas Cart√£o","Doa√ß√µes Institui√ß√µes","Diarista Luc√©lia","Energia","FGTS","Financiamento Solar","Forn √Ågua","Forn Armazem","Forn ASSAI","FORN BEIJU","FORN BETANIA","FORN BOLACHA FOL","FORN BOMBONIERE","FORN BUNGE","FORN CASTANHA","FORN CACHOEIRA","FORN COCO","FORN EMBALAGENS","FORN ELMA CHIPS","FORN ESTRELA (FARINHA)","FORN FARM√ÅCIA","FORN FORPAN","FORN FRIGORIFICO","FORN FRIOS INDUSTRIA","FORN FRIOS PANEVIE","FORN G√ÅS","FORN ISIS","FORN JANDAIA","FORN LINDENBERG","FORN M. DIAS BRANCO","FORN MERC ADRIEL","FORN MILFRIOS","FORN DE OVOS","FORN OMEGA","FORN PADEIR√ÉO","FORN PAMONHA","FORN P√ÉO DE QUEIJO","FORN PEPSICO","FORN PRODUTOS DE LIMPEZA","FORN REFRI","FORN ROYAL","FORN SOLMAR","FORN SR RICARDO","FORN TEMP BOLOS","FORN TAPIOCA LEONARDO","FORN TAPIOCA ZEZO","INSS","INTERNET","PARCELAMENTO RECEITA FEDERAL","DESPESAS MOTO","PONTO DAS REFRIGERA√á√ïES","MANUTEN√á√ÉO FIORINO","MANUTEN√á√ÉO PADARIA","PRESTA√á√ÉO FURG√ÉO","RP CONSULTORIA","SAL√ÅRIO MICHELE","SAL√ÅRIO ANGELA","SAL√ÅRIO JULIANA","SAL√ÅRIO RAIMUNDO","SAL√ÅRIO CARLOS","SAL√ÅRIO GABRIEL","SAL√ÅRIO LUCIO","SAL√ÅRIO LUCIENE","SAL√ÅRIO ALINE","SAL√ÅRIO Z√â","SEGURO BRADESCO","SEGURO PREDIAL","SINDPAN","SISTEMA","TAXA BANC√ÅRIA","SIMPLES NACIONAL","DIARISTA","EMBALAGEM PAPAI","ENERGIA SOLAR","FORN. QUEIJO","MAQUIN√ÅRIO CETRO","MAQUIN√ÅRIO ITAIYMAC","MAQUILAR","SAL√ÅRIO LUANA","SAL√ÅRIO PAULO","SAL√ÅRIO D. BRANCA","TIM","MARFRIOS","SAL√ÅRIO SOCORRO","ESPORTE J√öLIA","CAGECE","CART√ÉO EXTRA","CART√ÉO BRADESCO","CART√ÉO ITA√ö","COL√âGIO JULIA","CONS√ìRCIO","ECC PARACURU","FIES LUCIO","FIES MARINA","IGREJA","JANETE","LAZER FAM√çLIA","LUZ","MANUTEN√á√ÉO CARRO","REFOR√áO J√öLIA","MERCANTIL","PLANO DE SA√öDE","PRESTA√á√ÉO CASA","COMBUSTIVEL","CARRO","TELEFONE","TV A CABO","CASA CCF","Outra"];
    
    let transacoesGeral = [];
    let planejadorGeral = [];
    let graficoLinhas = null;
    let graficoCategorias = null;

    const totalReceitasEl = document.getElementById('total-receitas');
    const totalDespesasEl = document.getElementById('total-despesas');
    const saldoTotalEl = document.getElementById('saldo-total');
    const tituloGraficoEl = document.getElementById('titulo-grafico');
    const btnRefresh = document.getElementById('btn-refresh');
    const btnToggleTheme = document.getElementById('btn-toggle-theme');
    const cardReceitas = document.getElementById('card-receitas');
    const cardDespesas = document.getElementById('card-despesas');
    const cardSaldo = document.getElementById('card-saldo');
    const modalDetalhes = document.getElementById('modal-detalhes');
    const modalDetalhesTitulo = document.getElementById('modal-detalhes-titulo');
    const modalDetalhesConteudo = document.getElementById('modal-detalhes-conteudo');
    const btnFecharDetalhes = document.getElementById('btn-fechar-detalhes');
    const modalRegistro = document.getElementById('modal-registro');
    const modalRegistroTitulo = document.getElementById('modal-registro-titulo');
    const btnAbrirModalReceita = document.getElementById('btn-abrir-modal-receita');
    const btnAbrirModalDespesa = document.getElementById('btn-abrir-modal-despesa');
    const btnFecharRegistro = document.getElementById('btn-fechar-registro');
    const btnCancelarRegistro = document.getElementById('btn-cancelar-registro');
    const formRegistro = document.getElementById('form-registro');
    const corpoTabelaPlanejador = document.getElementById('corpo-tabela-planejador');
    const datalistLocais = document.getElementById('datalist-locais');
    const datalistFontes = document.getElementById('datalist-fontes');
    const modalPlanejador = document.getElementById('modal-planejador');
    const modalPlanejadorTitulo = document.getElementById('modal-planejador-titulo');
    const btnAbrirModalPlanejador = document.getElementById('btn-abrir-modal-planejador');
    const btnFecharPlanejador = document.getElementById('btn-fechar-planejador');
    const btnCancelarPlanejador = document.getElementById('btn-cancelar-planejador');
    const formPlanejador = document.getElementById('form-planejador');
    const btnExportReceitas = document.getElementById('btn-export-receitas');
    const btnExportDespesas = document.getElementById('btn-export-despesas');

    const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatarData = (data) => data instanceof Date && !isNaN(data) ? data.toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'Data inv√°lida';
    
    const popularDatalist = (datalistEl, lista) => {
        datalistEl.innerHTML = '';
        lista.sort().forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            datalistEl.appendChild(option);
        });
    };

    function carregarDados() {
        const dadosTransacoes = localStorage.getItem('minhasFinancas');
        const dadosPlanejador = localStorage.getItem('meuPlanejador');
        if (dadosTransacoes) {
            transacoesGeral = JSON.parse(dadosTransacoes).map(item => ({...item, Data: new Date(item.Data)}));
        }
        if (dadosPlanejador) {
            planejadorGeral = JSON.parse(dadosPlanejador).map(item => ({...item, Data: new Date(item.Data)}));
        }
        atualizarAplicacao();
    }

    function salvarDados() {
        localStorage.setItem('minhasFinancas', JSON.stringify(transacoesGeral));
        localStorage.setItem('meuPlanejador', JSON.stringify(planejadorGeral));
    }
    
    function atualizarAplicacao() {
        salvarDados();
        renderizarPlanejador();
        aplicarFiltros();
    }

    function aplicarFiltros() {
        const tipoFiltro = document.querySelector('#filtro-tipo .active').dataset.tipo;
        const periodoFiltro = document.querySelector('#filtro-periodo .active').dataset.periodo;
        const hoje = new Date();
        const transacoesAtuaisFiltradas = transacoesGeral.filter(t => {
            if (!t || !t.Data || !(t.Data instanceof Date)) return false;
            if (tipoFiltro !== 'Todos' && t.Tipo !== tipoFiltro) return false;
            switch(periodoFiltro) {
                case 'Diario': return dateFns.isSameDay(t.Data, hoje);
                case 'Semanal': return dateFns.isThisWeek(t.Data, { weekStartsOn: 1 });
                case 'Mensal': return dateFns.isSameMonth(t.Data, hoje);
                case 'Anual': return dateFns.isSameYear(t.Data, hoje);
                default: return true;
            }
        });
        tituloGraficoEl.textContent = `Evolu√ß√£o Financeira (${periodoFiltro})`;
        atualizarDashboard(transacoesAtuaisFiltradas);
    }
    
    function atualizarDashboard(transacoes) {
        atualizarCards(transacoes);
        criarGraficoLinhas(transacoes);
        criarGraficoCategorias(transacoes);
    }

    function atualizarCards(transacoes) {
        const receitas = transacoes.filter(t => t.Tipo === 'Receita').reduce((acc, t) => acc + (t.Valor || 0), 0);
        const despesas = transacoes.filter(t => t.Tipo === 'Despesa').reduce((acc, t) => acc + (t.Valor || 0), 0);
        const saldo = receitas - despesas;
        totalReceitasEl.textContent = formatarMoeda(receitas);
        totalDespesasEl.textContent = formatarMoeda(despesas);
        saldoTotalEl.textContent = formatarMoeda(saldo);
    }

    function renderizarPlanejador() {
        planejadorGeral.sort((a, b) => a.Data - b.Data);
        corpoTabelaPlanejador.innerHTML = '';
        planejadorGeral.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = `status-Pendente`;
            tr.innerHTML = `
                <td>${formatarData(item.Data)}</td>
                <td>${item.Fonte}</td>
                <td>${formatarMoeda(item.Valor)}</td>
                <td class="acoes">
                    <button class="btn-icon btn-marcar-pago" data-id="${item.id}" title="Marcar como Pago">‚úîÔ∏è</button>
                    <button class="btn-icon btn-editar-planejado" data-id="${item.id}" title="Editar">‚úèÔ∏è</button>
                    <button class="btn-icon btn-excluir-planejado" data-id="${item.id}" title="Excluir">üóëÔ∏è</button>
                </td>`;
            corpoTabelaPlanejador.appendChild(tr);
        });
    }

    function exibirDetalhesModal(tipo) {
        let transacoesParaExibir = [];
        if (tipo === 'Receita' || tipo === 'Despesa') {
            modalDetalhesTitulo.textContent = `Detalhes de ${tipo}s`;
            transacoesParaExibir = transacoesGeral.filter(t => t.Tipo === tipo);
        } else {
             modalDetalhesTitulo.textContent = `Detalhes do Per√≠odo`;
             transacoesParaExibir = transacoesGeral;
        }
        transacoesParaExibir.sort((a,b) => b.Data - a.Data);
        let html = '<p style="text-align:center; padding: 20px;">Nenhuma transa√ß√£o encontrada.</p>';
        if (transacoesParaExibir.length > 0) {
            const tableRows = transacoesParaExibir.map(t => `<tr style="color: ${t.Tipo === 'Receita' ? 'var(--cor-verde)' : 'var(--cor-vermelho)'}"><td>${formatarData(t.Data)}</td><td>${t.Local || '-'}</td><td>${t.Fonte || '-'}</td><td style="text-align:right;">${formatarMoeda(t.Valor)}</td></tr>`).join('');
            html = `<table class="tabela-contas"><thead><tr><th>Data</th><th>Local</th><th>Fonte</th><th style="text-align:right;">Valor</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        }
        modalDetalhesConteudo.innerHTML = html;
        modalDetalhes.style.display = 'flex';
    }
    
    function criarGraficoLinhas(transacoes) {
        const ctx = document.getElementById('grafico-linhas').getContext('2d');
        if (graficoLinhas) graficoLinhas.destroy();
        if (transacoes.length === 0) { graficoLinhas = null; return; }
        const periodoFiltro = document.querySelector('#filtro-periodo .active').dataset.periodo;
        let unit;
        switch(periodoFiltro) { case 'Diario': unit = 'hour'; break; case 'Semanal': case 'Mensal': unit = 'day'; break; case 'Anual': unit = 'month'; break; }
        const dadosAgrupados = transacoes.reduce((acc, t) => {
            const d = t.Data;
            if (!d || isNaN(d.getTime())) return acc;
            let chaveObj;
            if (unit === 'hour') chaveObj = new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours());
            else if (unit === 'day') chaveObj = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            else if (unit === 'month') chaveObj = new Date(d.getFullYear(), d.getMonth(), 1);
            else chaveObj = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const chave = chaveObj.toISOString();
            if (!acc[chave]) acc[chave] = { receitas: 0, despesas: 0 };
            if (t.Tipo === 'Receita') acc[chave].receitas += (t.Valor || 0);
            else if (t.Tipo === 'Despesa') acc[chave].despesas += (t.Valor || 0);
            return acc;
        }, {});
        const labels = Object.keys(dadosAgrupados).sort((a,b) => new Date(a) - new Date(b));
        graficoLinhas = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Receitas', data: labels.map(key => dadosAgrupados[key].receitas), borderColor: 'var(--cor-verde)', backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true, tension: 0.3 }, { label: 'Despesas', data: labels.map(key => dadosAgrupados[key].despesas), borderColor: 'var(--cor-vermelho)', backgroundColor: 'rgba(239, 68, 68, 0.2)', fill: true, tension: 0.3 }] }, options: { responsive: true, scales: { x: { type: 'time', time: { unit: unit, tooltipFormat: 'dd/MM/yyyy' } }, y: { beginAtZero: true, ticks: { callback: value => formatarMoeda(value) } } } } });
    }
    
    function criarGraficoCategorias(transacoes) {
        const ctx = document.getElementById('grafico-categorias').getContext('2d');
        if (graficoCategorias) graficoCategorias.destroy();
        const despesas = transacoes.filter(t => t.Tipo === 'Despesa');
        if (despesas.length === 0) { graficoCategorias = null; return; }
        const dadosAgrupados = despesas.reduce((acc, t) => {
            const fonte = t.Fonte || 'N√£o especificado';
            if (!acc[fonte]) acc[fonte] = 0;
            acc[fonte] += (t.Valor || 0);
            return acc;
        }, {});
        const top10 = Object.entries(dadosAgrupados).sort(([,a],[,b]) => b - a).slice(0, 10);
        document.getElementById('titulo-categorias').textContent = 'Top 10 Despesas por Fonte';
        graficoCategorias = new Chart(ctx, { type: 'bar', data: { labels: top10.map(([fonte]) => fonte), datasets: [{ label: `Valor Total`, data: top10.map(([,valor]) => valor), backgroundColor: 'rgba(239, 68, 68, 0.7)' }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { callback: value => formatarMoeda(value) } } } } });
    }

    function abrirModalRegistro(tipo) {
        formRegistro.reset();
        document.getElementById('reg-data').valueAsDate = new Date();
        document.getElementById('reg-tipo').value = tipo;
        popularDatalist(datalistLocais, locais);
        const grupoStatus = document.getElementById('grupo-status');
        if (tipo === 'Receita') {
            modalRegistroTitulo.textContent = 'Registrar Nova Receita';
            popularDatalist(datalistFontes, fontesReceita);
            grupoStatus.style.display = 'none';
            btnSalvarRegistro.className = 'btn btn-verde';
        } else {
            modalRegistroTitulo.textContent = 'Registrar Nova Despesa';
            popularDatalist(datalistFontes, fontesDespesa);
            grupoStatus.style.display = 'flex';
            btnSalvarRegistro.className = 'btn btn-vermelho';
        }
        modalRegistro.style.display = 'flex';
    };

    function abrirModalPlanejador(item = null) {
        formPlanejador.reset();
        popularDatalist(document.getElementById('datalist-fontes'), fontesDespesa);
        if (item) {
            modalPlanejadorTitulo.textContent = "Editar Conta a Pagar";
            document.getElementById('planejador-id').value = item.id;
            document.getElementById('planejador-data').value = dateFns.format(item.Data, 'yyyy-MM-dd');
            document.getElementById('planejador-fonte').value = item.Fonte;
            document.getElementById('planejador-valor').value = String(item.Valor).replace('.', ',');
        } else {
            modalPlanejadorTitulo.textContent = "Adicionar Conta a Pagar";
            document.getElementById('planejador-id').value = '';
            document.getElementById('planejador-data').valueAsDate = new Date();
        }
        modalPlanejador.style.display = 'flex';
    }

    // --- EVENT LISTENERS ---
    btnRefresh.addEventListener('click', () => location.reload());
    btnAbrirModalReceita.addEventListener('click', () => abrirModalRegistro('Receita'));
    btnAbrirModalDespesa.addEventListener('click', () => abrirModalRegistro('Despesa'));
    btnFecharRegistro.addEventListener('click', () => modalRegistro.style.display = 'none');
    btnCancelarRegistro.addEventListener('click', () => modalRegistro.style.display = 'none');
    cardReceitas.addEventListener('click', () => exibirDetalhesModal('Receita'));
    cardDespesas.addEventListener('click', () => exibirDetalhesModal('Despesa'));
    cardSaldo.addEventListener('click', () => exibirDetalhesModal('Saldo'));
    btnFecharDetalhes.addEventListener('click', () => modalDetalhes.style.display = 'none');
    btnAbrirModalPlanejador.addEventListener('click', () => abrirModalPlanejador());
    btnFecharPlanejador.addEventListener('click', () => modalPlanejador.style.display = 'none');
    btnCancelarPlanejador.addEventListener('click', () => modalPlanejador.style.display = 'none');

    document.querySelectorAll('.btn-filtro').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.target.closest('.grupo-filtro').querySelector('.active').classList.remove('active');
            e.target.classList.add('active');
            aplicarFiltros();
        });
    });
    
    document.body.addEventListener('click', function(e) {
        const target = e.target.closest('button');
        if (!target) return;
        const id = parseInt(target.dataset.id, 10);
        if (target.classList.contains('btn-marcar-pago')) {
            const index = planejadorGeral.findIndex(item => item.id === id);
            const itemParaPagar = planejadorGeral[index];
            if (itemParaPagar && confirm(`Deseja marcar a despesa "${itemParaPagar.Fonte}" de ${formatarMoeda(itemParaPagar.Valor)} como paga?`)) {
                planejadorGeral.splice(index, 1);
                transacoesGeral.push({ ...itemParaPagar, Status: 'Pago' });
                atualizarAplicacao();
            }
        } else if (target.classList.contains('btn-editar-planejado')) {
            const itemParaEditar = planejadorGeral.find(item => item.id === id);
            abrirModalPlanejador(itemParaEditar);
        } else if (target.classList.contains('btn-excluir-planejado')) {
            const index = planejadorGeral.findIndex(item => item.id === id);
            if (index > -1 && confirm(`Tem certeza que deseja excluir a conta "${planejadorGeral[index].Fonte}"?`)) {
                planejadorGeral.splice(index, 1);
                atualizarAplicacao();
            }
        }
    });
    
    formRegistro.addEventListener('submit', (e) => {
        e.preventDefault();
        const valorInput = document.getElementById('reg-valor').value.replace(/\./g, '').replace(',', '.');
        if (isNaN(parseFloat(valorInput))) { alert('Por favor, insira um valor num√©rico v√°lido.'); return; }
        const dados = { 
            id: Date.now(),
            Data: new Date(document.getElementById('reg-data').value + 'T12:00:00Z'),
            Tipo: document.getElementById('reg-tipo').value, 
            Valor: parseFloat(valorInput), 
            Fonte: document.getElementById('reg-fonte').value, 
            Local: document.getElementById('reg-local').value, 
            Descricao: '', 
            Status: document.getElementById('reg-tipo').value === 'Despesa' ? document.getElementById('reg-status').value : 'Pago'
        };
        if (dados.Status === 'Pendente') {
            planejadorGeral.push(dados);
        } else {
            transacoesGeral.push(dados);
        }
        atualizarAplicacao();
        modalRegistro.style.display = 'none';
        alert('Transa√ß√£o registrada com sucesso!');
    });

    formPlanejador.addEventListener('submit', (e) => {
        e.preventDefault();
        const valorInput = document.getElementById('planejador-valor').value.replace(/\./g, '').replace(',', '.');
        if (isNaN(parseFloat(valorInput))) { alert('Por favor, insira um valor num√©rico v√°lido.'); return; }
        const id = parseInt(document.getElementById('planejador-id').value, 10);
        if (id) { // Editando
            const item = planejadorGeral.find(p => p.id === id);
            item.Data = new Date(document.getElementById('planejador-data').value + 'T12:00:00Z');
            item.Fonte = document.getElementById('planejador-fonte').value;
            item.Valor = parseFloat(valorInput);
        } else { // Novo
            planejadorGeral.push({
                id: Date.now(),
                Data: new Date(document.getElementById('planejador-data').value + 'T12:00:00Z'),
                Fonte: document.getElementById('planejador-fonte').value,
                Valor: parseFloat(valorInput)
            });
        }
        atualizarAplicacao();
        modalPlanejador.style.display = 'none';
    });

    function aplicarTema(tema) {
        document.body.classList.toggle('dark-mode', tema === 'dark');
        btnToggleTheme.innerHTML = tema === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    }
    btnToggleTheme.addEventListener('click', () => {
        const temaAtual = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        localStorage.setItem('temaDashboard', temaAtual);
        aplicarTema(temaAtual);
    });

    function exportarParaPDF(tipo) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const hoje = new Date();
        const transacoesFiltradas = transacoesGeral.filter(t => t.Tipo === tipo);
        const totalSemanal = transacoesFiltradas.filter(t => dateFns.isThisWeek(t.Data, { weekStartsOn: 1 })).reduce((acc, t) => acc + t.Valor, 0);
        const totalMensal = transacoesFiltradas.filter(t => dateFns.isSameMonth(t.Data, hoje)).reduce((acc, t) => acc + t.Valor, 0);
        const totalAnual = transacoesFiltradas.filter(t => dateFns.isSameYear(t.Data, hoje)).reduce((acc, t) => acc + t.Valor, 0);
        
        doc.setFontSize(18); doc.text(`Relat√≥rio de ${tipo}s`, 14, 22);
        doc.setFontSize(11); doc.setTextColor(100);
        const summaryText = `Total Semana Atual: ${formatarMoeda(totalSemanal)}\nTotal M√™s Atual: ${formatarMoeda(totalMensal)}\nTotal Ano Atual: ${formatarMoeda(totalAnual)}`;
        doc.text(summaryText, 14, 32);
        const tableColumn = ["Data", "Fonte", "Local", "Valor"];
        const tableRows = [];
        transacoesFiltradas.sort((a,b) => b.Data - a.Data).forEach(item => {
            const transacaoData = [ formatarData(item.Data), item.Fonte, item.Local || '-', formatarMoeda(item.Valor) ];
            tableRows.push(transacaoData);
        });
        doc.autoTable({ head: [tableColumn], body: tableRows, startY: 60, theme: 'striped', headStyles: { fillColor: tipo === 'Receita' ? [22, 163, 74] : [220, 38, 38] } });
        doc.save(`relatorio_${tipo.toLowerCase()}s.pdf`);
    }
    btnExportReceitas.addEventListener('click', () => exportarParaPDF('Receita'));
    btnExportDespesas.addEventListener('click', () => exportarParaPDF('Despesa'));
    
    // --- INICIALIZA√á√ÉO ---
    aplicarTema(localStorage.getItem('temaDashboard') || 'light');
    carregarDados();
});
</script>
</body>
</html>
