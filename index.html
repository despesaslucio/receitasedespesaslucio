<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Definitivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <style>
        :root { --cor-fundo: #f0f2f5; --cor-texto: #363f5f; --cor-texto-leve: #969cb3; --cor-card: #ffffff; --cor-borda: #e2e8f0; --cor-verde: #10b981; --cor-vermelho: #ef4444; --cor-azul: #3b82f6; --cor-amarelo-fundo: #fef9c3; --cor-amarelo-texto: #a16207; --sombra-card: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --transicao: all 0.3s ease-in-out; }
        body.dark-mode { --cor-fundo: #1a202c; --cor-texto: #e2e8f0; --cor-texto-leve: #a0aec0; --cor-card: #2d3748; --cor-borda: #4a5568; --cor-amarelo-fundo: #4a4a28; --cor-amarelo-texto: #fef08a;}
        body { font-family: 'Poppins', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); margin: 0; padding: 20px; transition: var(--transicao); }
        .container { max-width: 1600px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 25px; flex-wrap: wrap; gap: 15px; border-bottom: 1px solid var(--cor-borda); margin-bottom: 25px; }
        .header-title { display: flex; align-items: center; gap: 15px; }
        header h1 { margin: 0; font-size: 2em; }
        .btn { padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transicao); font-weight: 500; border: none; cursor: pointer; }
        .btn-verde { background-color: var(--cor-verde); color: white; }
        .btn-vermelho { background-color: var(--cor-vermelho); color: white; }
        .btn-icon { background: none; border: none; font-size: 1.3em; cursor: pointer; color: var(--cor-texto-leve); transition: var(--transicao); }
        .btn-icon:hover { color: var(--cor-texto); }
        .cards-resumo { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .card { background-color: var(--cor-card); padding: 25px; border-radius: 12px; box-shadow: var(--sombra-card); border: 1px solid var(--cor-borda); transition: var(--transicao); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .card.clicavel { cursor: pointer; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: var(--cor-texto-leve); font-weight: 500; }
        .card-header i { font-size: 2em; }
        .card .valor { font-size: 2.2em; font-weight: 600; }
        .card.receitas { border-left: 5px solid var(--cor-verde); } .card.receitas .valor, .card.receitas i { color: var(--cor-verde); }
        .card.despesas { border-left: 5px solid var(--cor-vermelho); } .card.despesas .valor, .card.despesas i { color: var(--cor-vermelho); }
        .card.saldo { border-left: 5px solid var(--cor-azul); } .card.saldo .valor, .card.saldo i { color: var(--cor-azul); }
        .secao-filtros { background-color: var(--cor-card); padding: 20px; border-radius: 12px; box-shadow: var(--sombra-card); margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .grupo-filtro { display: flex; align-items: center; gap: 10px; }
        .btn-filtro { background-color: var(--cor-fundo); border: 1px solid var(--cor-borda); padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: var(--transicao); font-weight: 500; }
        .btn-filtro.active { background-color: var(--cor-azul); color: white; border-color: var(--cor-azul); }
        .grid-principal { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .widget { background-color: var(--cor-card); padding: 25px; border-radius: 12px; box-shadow: var(--sombra-card); border: 1px solid var(--cor-borda); position: relative; }
        .widget h2 { margin-top: 0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .tabela-contas-wrapper { max-height: 400px; overflow-y: auto; }
        .tabela-contas { width: 100%; border-collapse: collapse; }
        .tabela-contas th, .tabela-contas td { text-align: left; padding: 14px; border-bottom: 1px solid var(--cor-borda); }
        .tabela-contas thead { position: sticky; top: 0; background-color: var(--cor-card); z-index: 1; }
        .tabela-contas tbody tr:hover { background-color: var(--cor-fundo); }
        .tabela-contas .status-Pendente { background-color: var(--cor-amarelo-fundo); color: var(--cor-amarelo-texto); font-weight: 500; }
        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .modal-content { background-color: var(--cor-card); padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: scaleUp 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-body { overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content form { display: flex; flex-direction: column; gap: 15px; }
        .form-grupo { display: flex; flex-direction: column; gap: 5px; }
        .form-grupo label { font-weight: 500; font-size: 0.9em; color: var(--cor-texto-leve); }
        .modal-content input, .modal-content select { padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; font-size: 1em; background-color: var(--cor-fundo); color: var(--cor-texto); }
        .form-botoes { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        @media (max-width: 1200px) { .grid-principal { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { body { padding: 10px; } header h1 { font-size: 1.5em; } .secao-filtros { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title"><h1>Dashboard Financeiro</h1><button class="btn-icon" id="btn-refresh" title="Atualizar dados"><i class="fa-solid fa-rotate-right"></i></button></div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn-icon" id="btn-toggle-theme" title="Mudar tema"><i class="fa-solid fa-moon"></i></button>
                <div class="grupo-botoes-registro">
                    <button id="btn-abrir-modal-receita" class="btn btn-verde"><i class="fa-solid fa-plus"></i> Receita</button>
                    <button id="btn-abrir-modal-despesa" class="btn btn-vermelho"><i class="fa-solid fa-minus"></i> Despesa</button>
                </div>
            </div>
        </header>

        <main>
            <section class="cards-resumo">
                <div class="card receitas clicavel" id="card-receitas"><div class="card-header"><span>Receitas</span><i class="fa-solid fa-circle-arrow-up"></i></div><p class="valor" id="total-receitas">R$ 0,00</p></div>
                <div class="card despesas clicavel" id="card-despesas"><div class="card-header"><span>Despesas</span><i class="fa-solid fa-circle-arrow-down"></i></div><p class="valor" id="total-despesas">R$ 0,00</p></div>
                <div class="card saldo clicavel" id="card-saldo"><div class="card-header"><span>Saldo</span><i class="fa-solid fa-scale-balanced"></i></div><p class="valor" id="saldo-total">R$ 0,00</p></div>
            </section>
            
            <section class="secao-filtros">
                 <div class="grupo-filtro" id="filtro-tipo"><button class="btn-filtro active" data-tipo="Todos">Todos</button><button class="btn-filtro" data-tipo="Receita">Receitas</button><button class="btn-filtro" data-tipo="Despesa">Despesas</button></div>
                 <div class="grupo-filtro" id="filtro-periodo"><button class="btn-filtro" data-periodo="Diario">Hoje</button><button class="btn-filtro" data-periodo="Semanal">Semana</button><button class="btn-filtro active" data-periodo="Mensal">Mês</button><button class="btn-filtro" data-periodo="Anual">Ano</button></div>
            </section>
            
            <div id="loading" style="text-align: center; padding: 50px; font-size: 1.5em; color: var(--cor-texto-leve);"><p><i class="fa-solid fa-spinner fa-spin"></i> Carregando dados...</p></div>

            <div id="dashboard-content" style="display:none;">
                <section class="grid-principal">
                    <div class="widget"> <h2 id="titulo-grafico">Evolução Financeira</h2> <canvas id="grafico-linhas"></canvas> </div>
                    <div class="widget"> <h2 id="titulo-categorias">Top 10 Despesas por Fonte</h2> <canvas id="grafico-categorias"></canvas> </div>
                    <div class="widget" style="grid-column: 1 / -1;"> <h2>Planejador de Contas</h2> <div class="tabela-contas-wrapper"><table class="tabela-contas"><thead><tr><th>Data</th><th>Fonte</th><th>Valor</th><th>Ações</th></tr></thead><tbody id="corpo-tabela-planejador"></tbody></table></div></div>
                </section>
            </div>
        </main>
    </div>
    
    <div id="modal-detalhes" class="modal-container">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-detalhes-titulo">Detalhes</h2><button id="btn-fechar-detalhes" class="btn-icon">&times;</button></div>
            <div id="modal-detalhes-conteudo" class="modal-body"></div>
        </div>
    </div>

    <div id="modal-registro" class="modal-container">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-registro-titulo">Registrar</h2><button id="btn-fechar-registro" class="btn-icon">&times;</button></div>
            <div class="modal-body">
                <form id="form-registro">
                    <input type="hidden" id="reg-tipo">
                    <div class="form-grupo"><label for="reg-data">Data da Transação</label><input type="date" id="reg-data" required></div>
                    <div class="form-grupo"><label for="reg-local">Local</label><select id="reg-local" required></select></div>
                    <div class="form-grupo"><label for="reg-fonte">Fonte</label><select id="reg-fonte" required></select></div>
                    <div class="form-grupo"><label for="reg-valor">Valor (R$)</label><input type="text" inputmode="decimal" id="reg-valor" placeholder="150,50" required></div>
                    <div class="form-grupo" id="grupo-status"><label for="reg-status">Status</label><select id="reg-status"><option value="Pago">Já foi pago</option><option value="Pendente">Conta a pagar (pendente)</option></select></div>
                    <div class="form-botoes">
                        <button type="button" class="btn" id="btn-cancelar-registro" style="background-color: #ccc;">Cancelar</button>
                        <button type="submit" class="btn" id="btn-salvar-registro"><span class="btn-text">Salvar</span><i class="fa-solid fa-spinner fa-spin" style="display: none;"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // COLE A SUA URL DO WEB APP AQUI (a URL do script do Google Apps Script implantado como Web App)
    const apiUrl = 'const apiUrl = 'https://cors-anywhere.herokuapp.com/https://script.google.com/macros/s/AKfycbwlVXt788tnLNkWqsx5H2c821bUGLmeXxnn0KO_ofDe8Ny1vivuctfrnAwSbATzEosY/exec';';
    
    // --- LISTAS DE OPÇÕES PARA OS FORMULÁRIOS (mantidas conforme o original) ---
    const locais = ["Panevie", "Buono Trigo Industria", "Casa"];
    const fontesReceita = ["Cartão Panevie", "Cartão Industria", "Cartão Buono Trigo", "Madrugada", "Outra"];
    const fontesDespesa = ["Água","Aluguel","Arrendamento padaria","Amora","Casa Garcia","Combustível Fiorino","Combustível Jumper","Comercial Mab","Confraternização","Contadora","DAS","Despesas Cartão","Doações Instituições","Diarista Lucélia","Energia","FGTS","Financiamento Solar","Forn Água","Forn Armazem","Forn ASSAI","FORN BEIJU","FORN BETANIA","FORN BOLACHA FOL","FORN BOMBONIERE","FORN BUNGE","FORN CASTANHA","FORN CACHOEIRA","FORN COCO","FORN EMBALAGENS","FORN ELMA CHIPS","FORN ESTRELA (FARINHA)","FORN FARMÁCIA","FORN FORPAN","FORN FRIGORIFICO","FORN FRIOS INDUSTRIA","FORN FRIOS PANEVIE","FORN GÁS","FORN ISIS","FORN JANDAIA","FORN LINDENBERG","FORN M. DIAS BRANCO","FORN MERC ADRIEL","FORN MILFRIOS","FORN DE OVOS","FORN OMEGA","FORN PADEIRÃO","FORN PAMONHA","FORN PÃO DE QUEIJO","FORN PEPSICO","FORN PRODUTOS DE LIMPEZA","FORN REFRI","FORN ROYAL","FORN SOLMAR","FORN SR RICARDO","FORN TEMP BOLOS","FORN TAPIOCA LEONARDO","FORN TAPIOCA ZEZO","INSS","INTERNET","PARCELAMENTO RECEITA FEDERAL","DESPESAS MOTO","PONTO DAS REFRIGERAÇÕES","MANUTENÇÃO FIORINO","MANUTENÇÃO PADARIA","PRESTAÇÃO FURGÃO","RP CONSULTORIA","SALÁRIO MICHELE","SALÁRIO ANGELA","SALÁRIO JULIANA","SALÁRIO RAIMUNDO","SALÁRIO CARLOS","SALÁRIO GABRIEL","SALÁRIO LUCIO","SALÁRIO LUCIENE","SALÁRIO ALINE","SALÁRIO ZÉ","SEGURO BRADESCO","SEGURO PREDIAL","SINDPAN","SISTEMA","TAXA BANCÁRIA","SIMPLES NACIONAL","DIARISTA","EMBALAGEM PAPAI","ENERGIA SOLAR","FORN. QUEIJO","MAQUINÁRIO CETRO","MAQUINÁRIO ITAIYMAC","MAQUILAR","SALÁRIO LUANA","SALÁRIO PAULO","SALÁRIO D. BRANCA","TIM","MARFRIOS","SALÁRIO SOCORRO","ESPORTE JÚLIA","CAGECE","CARTÃO EXTRA","CARTÃO BRADESCO","CARTÃO ITAÚ","COLÉGIO JULIA","CONSÓRCIO","ECC PARACURU","FIES LUCIO","FIES MARINA","IGREJA","JANETE","LAZER FAMÍLIA","LUZ","MANUTENÇÃO CARRO","REFORÇO JÚLIA","MERCANTIL","PLANO DE SAÚDE","PRESTAÇÃO CASA","COMBUSTIVEL","CARRO","TELEFONE","TV A CABO","CASA CCF","Outra"];
    
    // --- VARIÁVEIS GLOBAIS ---
    let transacoesGeral = [];
    let graficoLinhas = null;
    let graficoCategorias = null;

    // --- ELEMENTOS DO DOM ---
    const loadingDiv = document.getElementById('loading');
    const dashboardContentDiv = document.getElementById('dashboard-content');
    const totalReceitasEl = document.getElementById('total-receitas');
    const totalDespesasEl = document.getElementById('total-despesas');
    const saldoTotalEl = document.getElementById('saldo-total');
    const tituloGraficoEl = document.getElementById('titulo-grafico');
    const btnRefresh = document.getElementById('btn-refresh');
    const btnToggleTheme = document.getElementById('btn-toggle-theme');
    const cardReceitas = document.getElementById('card-receitas');
    const cardDespesas = document.getElementById('card-despesas');
    const cardSaldo = document.getElementById('card-saldo');
    const modalDetalhes = document.getElementById('modal-detalhes');
    const modalDetalhesTitulo = document.getElementById('modal-detalhes-titulo');
    const modalDetalhesConteudo = document.getElementById('modal-detalhes-conteudo');
    const btnFecharDetalhes = document.getElementById('btn-fechar-detalhes');
    const modalRegistro = document.getElementById('modal-registro');
    const modalRegistroTitulo = document.getElementById('modal-registro-titulo');
    const btnAbrirModalReceita = document.getElementById('btn-abrir-modal-receita');
    const btnAbrirModalDespesa = document.getElementById('btn-abrir-modal-despesa');
    const btnFecharRegistro = document.getElementById('btn-fechar-registro');
    const btnCancelarRegistro = document.getElementById('btn-cancelar-registro');
    const formRegistro = document.getElementById('form-registro');
    const btnSalvarRegistro = document.getElementById('btn-salvar-registro');
    const corpoTabelaPlanejador = document.getElementById('corpo-tabela-planejador');

    // --- FUNÇÕES UTILITÁRIAS ---
    const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const formatarData = (data) => data instanceof Date && !isNaN(data) ? data.toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'Data inválida';
    
    const popularSelect = (selectEl, lista) => {
        selectEl.innerHTML = '';
        lista.sort().forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            selectEl.appendChild(option);
        });
    };

    // --- LÓGICA DE DADOS ---
    async function carregarDadosIniciais() {
        loadingDiv.style.display = 'block';
        dashboardContentDiv.style.display = 'none';
        btnRefresh.firstElementChild.classList.add('fa-spin');
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Erro na rede (Status: ${response.status})`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            if (!Array.isArray(result)) throw new Error('A resposta da API não é uma lista.');
            transacoesGeral = result.map(item => ({...item, Data: new Date(item.Data)})).filter(t => t.Data instanceof Date && !isNaN(t.Data));
            renderizarPlanejador();
            aplicarFiltros();
            loadingDiv.style.display = 'none';
            dashboardContentDiv.style.display = 'block';
        } catch (error) {
            console.error('Erro ao buscar dados:', error);
            loadingDiv.innerHTML = `<p style="color:var(--cor-vermelho);"><i class="fa-solid fa-circle-xmark"></i> Falha ao carregar: ${error.message}.</p>`;
        } finally {
            btnRefresh.firstElementChild.classList.remove('fa-spin');
        }
    }

    async function submeterDados(dados) {
        const btnText = btnSalvarRegistro.querySelector('.btn-text');
        const btnSpinner = btnSalvarRegistro.querySelector('.fa-spinner');
        if (btnText && btnSpinner) { btnText.textContent = 'Salvando...'; btnSpinner.style.display = 'inline-block'; btnSalvarRegistro.disabled = true; }
        try {
            const response = await fetch(apiUrl, { method: 'POST', body: JSON.stringify(dados), headers: {'Content-Type': 'application/json'} });
            if (!response.ok) throw new Error(`Erro na rede ao salvar (Status: ${response.status})`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            alert('Transação registrada com sucesso!');
            if (modalRegistro.style.display !== 'none') modalRegistro.style.display = 'none';
            setTimeout(() => carregarDadosIniciais(), 1500);
        } catch (error) {
            alert('Erro ao registrar: ' + error.message);
        } finally {
             if (btnText && btnSpinner) { btnSalvarRegistro.disabled = false; btnText.textContent = 'Salvar'; btnSpinner.style.display = 'none'; }
        }
    }

    // --- LÓGICA DE RENDERIZAÇÃO E ATUALIZAÇÃO ---
    function aplicarFiltros() {
        const tipoFiltro = document.querySelector('#filtro-tipo .active').dataset.tipo;
        const periodoFiltro = document.querySelector('#filtro-periodo .active').dataset.periodo;
        const hoje = new Date();
        const transacoesVisiveis = transacoesGeral.filter(t => t.Status !== 'Pendente');
        const transacoesAtuaisFiltradas = transacoesVisiveis.filter(t => {
            if (!t || !t.Data) return false;
            if (tipoFiltro !== 'Todos' && t.Tipo !== tipoFiltro) return false;
            switch(periodoFiltro) {
                case 'Diario': return dateFns.isSameDay(t.Data, hoje);
                case 'Semanal': return dateFns.isThisWeek(t.Data, { weekStartsOn: 1 });
                case 'Mensal': return dateFns.isSameMonth(t.Data, hoje);
                case 'Anual': return dateFns.isSameYear(t.Data, hoje);
                default: return true;
            }
        });
        document.getElementById('titulo-grafico').textContent = `Evolução Financeira (${periodoFiltro})`;
        atualizarDashboard(transacoesAtuaisFiltradas);
    }
    
    function atualizarDashboard(transacoes) {
        atualizarCards(transacoes);
        criarGraficoLinhas(transacoes);
        criarGraficoCategorias(transacoes);
    }

    function atualizarCards(transacoes) {
        const receitas = transacoes.filter(t => t.Tipo === 'Receita').reduce((acc, t) => acc + (t.Valor || 0), 0);
        const despesas = transacoes.filter(t => t.Tipo === 'Despesa').reduce((acc, t) => acc + (t.Valor || 0), 0);
        const saldo = receitas - despesas;
        totalReceitasEl.textContent = formatarMoeda(receitas);
        totalDespesasEl.textContent = formatarMoeda(despesas);
        saldoTotalEl.textContent = formatarMoeda(saldo);
    }

    function renderizarPlanejador() {
        const planejadorItens = transacoesGeral.filter(t => t.Status === 'Pendente');
        planejadorItens.sort((a, b) => a.Data - b.Data);
        corpoTabelaPlanejador.innerHTML = '';
        planejadorItens.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = `status-Pendente`;
            const originalIndex = transacoesGeral.findIndex(t => t === item);
            tr.innerHTML = `<td>${formatarData(item.Data)}</td><td>${item.Fonte}</td><td>${formatarMoeda(item.Valor)}</td><td><button class="btn-icon btn-marcar-pago" data-index="${originalIndex}" title="Marcar como Pago">✔️</button></td>`;
            corpoTabelaPlanejador.appendChild(tr);
        });
    }

    function exibirDetalhesModal(tipo) {
        const transacoesVisiveis = transacoesGeral.filter(t => t.Status !== 'Pendente');
        let transacoesParaExibir = [];
        if (tipo === 'Receita' || tipo === 'Despesa') {
            modalDetalhesTitulo.textContent = `Detalhes de ${tipo}s`;
            transacoesParaExibir = transacoesVisiveis.filter(t => t.Tipo === tipo);
        } else {
             modalDetalhesTitulo.textContent = `Detalhes do Período`;
             transacoesParaExibir = transacoesVisiveis;
        }
        transacoesParaExibir.sort((a,b) => b.Data - a.Data);
        let html = '<p style="text-align:center; padding: 20px;">Nenhuma transação encontrada.</p>';
        if (transacoesParaExibir.length > 0) {
            const tableRows = transacoesParaExibir.map(t => `<tr style="color: ${t.Tipo === 'Receita' ? 'var(--cor-verde)' : 'var(--cor-vermelho)'}"><td>${formatarData(t.Data)}</td><td>${t.Local || '-'}</td><td>${t.Fonte || '-'}</td><td style="text-align:right;">${formatarMoeda(t.Valor)}</td></tr>`).join('');
            html = `<table class="tabela-contas"><thead><tr><th>Data</th><th>Local</th><th>Fonte</th><th style="text-align:right;">Valor</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        }
        modalDetalhesConteudo.innerHTML = html;
        modalDetalhes.style.display = 'flex';
    }
    
    function criarGraficoLinhas(transacoes) {
        const ctx = document.getElementById('grafico-linhas').getContext('2d');
        if (graficoLinhas) graficoLinhas.destroy();
        if (transacoes.length === 0) { graficoLinhas = null; return; }
        const periodoFiltro = document.querySelector('#filtro-periodo .active').dataset.periodo;
        let unit;
        switch(periodoFiltro) { case 'Diario': unit = 'hour'; break; case 'Semanal': case 'Mensal': unit = 'day'; break; case 'Anual': unit = 'month'; break; }
        const dadosAgrupados = transacoes.reduce((acc, t) => {
            const d = t.Data;
            if (!d || isNaN(d.getTime())) return acc;
            const chave = dateFns.startOf(d, unit).toISOString();
            if (!acc[chave]) acc[chave] = { receitas: 0, despesas: 0 };
            if (t.Tipo === 'Receita') acc[chave].receitas += (t.Valor || 0);
            else if (t.Tipo === 'Despesa') acc[chave].despesas += (t.Valor || 0);
            return acc;
        }, {});
        const labels = Object.keys(dadosAgrupados).sort((a,b) => new Date(a) - new Date(b));
        graficoLinhas = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Receitas', data: labels.map(key => dadosAgrupados[key].receitas), borderColor: 'var(--cor-verde)', backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true, tension: 0.3 }, { label: 'Despesas', data: labels.map(key => dadosAgrupados[key].despesas), borderColor: 'var(--cor-vermelho)', backgroundColor: 'rgba(239, 68, 68, 0.2)', fill: true, tension: 0.3 }] }, options: { responsive: true, scales: { x: { type: 'time', time: { unit: unit, tooltipFormat: 'dd/MM/yyyy' } }, y: { beginAtZero: true, ticks: { callback: value => formatarMoeda(value) } } } } });
    }
    
    function criarGraficoCategorias(transacoes) {
        const ctx = document.getElementById('grafico-categorias').getContext('2d');
        if (graficoCategorias) graficoCategorias.destroy();
        const despesas = transacoes.filter(t => t.Tipo === 'Despesa');
        if (despesas.length === 0) { graficoCategorias = null; return; }
        const dadosAgrupados = despesas.reduce((acc, t) => {
            const fonte = t.Fonte || 'Não especificado';
            if (!acc[fonte]) acc[fonte] = 0;
            acc[fonte] += (t.Valor || 0);
            return acc;
        }, {});
        const top10 = Object.entries(dadosAgrupados).sort(([,a],[,b]) => b - a).slice(0, 10);
        document.getElementById('titulo-categorias').textContent = 'Top 10 Despesas por Fonte';
        graficoCategorias = new Chart(ctx, { type: 'bar', data: { labels: top10.map(([fonte]) => fonte), datasets: [{ label: `Valor Total`, data: top10.map(([,valor]) => valor), backgroundColor: 'rgba(239, 68, 68, 0.7)' }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { callback: value => formatarMoeda(value) } } } } });
    }

    function abrirModalRegistro(tipo) {
        modalRegistroTitulo.textContent = `Registrar ${tipo}`;
        document.getElementById('reg-tipo').value = tipo;
        document.getElementById('reg-data').value = new Date().toISOString().split('T')[0];
        popularSelect(document.getElementById('reg-local'), locais);
        const fontes = tipo === 'Receita' ? fontesReceita : fontesDespesa;
        popularSelect(document.getElementById('reg-fonte'), fontes);
        document.getElementById('reg-valor').value = '';
        const grupoStatus = document.getElementById('grupo-status');
        grupoStatus.style.display = tipo === 'Despesa' ? 'block' : 'none';
        if (tipo === 'Receita') {
            document.getElementById('reg-status').value = 'Pago';
        }
        modalRegistro.style.display = 'flex';
    }

    // --- EVENT LISTENERS ---
    btnRefresh.addEventListener('click', carregarDadosIniciais);
    cardReceitas.addEventListener('click', () => exibirDetalhesModal('Receita'));
    cardDespesas.addEventListener('click', () => exibirDetalhesModal('Despesa'));
    cardSaldo.addEventListener('click', () => exibirDetalhesModal('Saldo'));
    btnFecharDetalhes.addEventListener('click', () => modalDetalhes.style.display = 'none');
    btnAbrirModalReceita.addEventListener('click', () => abrirModalRegistro('Receita'));
    btnAbrirModalDespesa.addEventListener('click', () => abrirModalRegistro('Despesa'));
    btnFecharRegistro.addEventListener('click', () => modalRegistro.style.display = 'none');
    btnCancelarRegistro.addEventListener('click', () => modalRegistro.style.display = 'none');

    document.body.addEventListener('click', function(e) {
        if (e.target.closest('.btn-marcar-pago')) {
            const btn = e.target.closest('.btn-marcar-pago');
            const index = btn.dataset.index;
            const itemParaPagar = transacoesGeral[index];
            if (confirm(`Deseja marcar a despesa "${itemParaPagar.Fonte}" de ${formatarMoeda(itemParaPagar.Valor)} como paga?`)) {
                const dadosUpdate = { row: itemParaPagar.rowIndex, status: 'Pago' };
                submeterDados(dadosUpdate);
            }
        }
    });
    
    formRegistro.addEventListener('submit', (e) => {
        e.preventDefault();
        const valorInput = document.getElementById('reg-valor').value.replace(/\./g, '').replace(',', '.');
        if (isNaN(parseFloat(valorInput))) { alert('Por favor, insira um valor numérico válido.'); return; }
        const status = document.getElementById('reg-tipo').value === 'Despesa' ? document.getElementById('reg-status').value : 'Pago';
        const dadosParaEnviar = { data: document.getElementById('reg-data').value, tipo: document.getElementById('reg-tipo').value, valor: parseFloat(valorInput), fonte: document.getElementById('reg-fonte').value, local: document.getElementById('reg-local').value, descricao: '', status: status };
        submeterDados(dadosParaEnviar);
    });

    const filtroTipoBtns = document.querySelectorAll('#filtro-tipo .btn-filtro');
    filtroTipoBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            filtroTipoBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            aplicarFiltros();
        });
    });

    const filtroPeriodoBtns = document.querySelectorAll('#filtro-periodo .btn-filtro');
    filtroPeriodoBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            filtroPeriodoBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            aplicarFiltros();
        });
    });

    function aplicarTema(tema) {
        document.body.classList.toggle('dark-mode', tema === 'dark');
        btnToggleTheme.innerHTML = tema === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    }
    btnToggleTheme.addEventListener('click', () => {
        const temaAtual = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        localStorage.setItem('temaDashboard', temaAtual);
        aplicarTema(temaAtual);
    });
    
    // --- INICIALIZAÇÃO ---
    aplicarTema(localStorage.getItem('temaDashboard') || 'light');
    carregarDadosIniciais();
});
</script>
</body>
</html>


